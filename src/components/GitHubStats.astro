---
interface Props {
  owner: string;
  repo: string;
}

const { owner, repo } = Astro.props;

let stars: number | null = null;
let forks: number | null = null;

const headers: HeadersInit = {
  'Accept': 'application/vnd.github.v3+json',
  'User-Agent': 'Ralph-Website-Builder'
};

// Use token in CI/production builds if available
if (import.meta.env.GITHUB_TOKEN) {
  headers['Authorization'] = `Bearer ${import.meta.env.GITHUB_TOKEN}`;
}

try {
  const response = await fetch(
    `https://api.github.com/repos/${owner}/${repo}`,
    { headers }
  );

  if (response.ok) {
    const data = await response.json();
    stars = data.stargazers_count;
    forks = data.forks_count;

    // Log rate limit info during build
    const remaining = response.headers.get('X-RateLimit-Remaining');
    const limit = response.headers.get('X-RateLimit-Limit');
    console.log(`GitHub API: ${remaining}/${limit} requests remaining`);
  } else {
    console.warn(`GitHub API returned ${response.status} for ${owner}/${repo}`);
  }
} catch (error) {
  console.warn(`Failed to fetch GitHub stats for ${owner}/${repo}:`, error);
}

// Format large numbers (e.g., 1234 -> "1.2k")
function formatNumber(num: number): string {
  if (num >= 1000) {
    return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
  }
  return num.toLocaleString();
}

// Only render if we successfully fetched stats
const hasStats = stars !== null;
---

{hasStats && (
  <span class="github-stats">
    <span class="stat" title={`${stars!.toLocaleString()} stars`}>
      <svg
        class="icon"
        viewBox="0 0 16 16"
        width="14"
        height="14"
        aria-hidden="true"
      >
        <path fill="currentColor" d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"></path>
      </svg>
      <span class="value">{formatNumber(stars!)}</span>
    </span>
    {forks !== null && forks > 0 && (
      <span class="stat" title={`${forks.toLocaleString()} forks`}>
        <svg
          class="icon"
          viewBox="0 0 16 16"
          width="14"
          height="14"
          aria-hidden="true"
        >
          <path fill="currentColor" d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"></path>
        </svg>
        <span class="value">{formatNumber(forks)}</span>
      </span>
    )}
  </span>
)}

<style>
  .github-stats {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    font-family: var(--font-mono);
    font-size: var(--text-code);
    color: var(--text-secondary);
  }

  .stat {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  .icon {
    opacity: 0.8;
    color: var(--signal);
  }

  .value {
    font-weight: 500;
    color: var(--text-primary);
  }
</style>
